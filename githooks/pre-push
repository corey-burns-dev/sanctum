#!/usr/bin/env bash
set -euo pipefail

# Repo-managed pre-push hook: ensure test DB is available (best-effort), then run quick e2e smoke tests
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# read DB connection params from environment or defaults
PGHOST=${PGHOST:-${DB_HOST:-localhost}}
PGPORT=${PGPORT:-${DB_PORT:-5432}}

check_pg() {
	if command -v pg_isready >/dev/null 2>&1; then
		pg_isready -h "$PGHOST" -p "$PGPORT" >/dev/null 2>&1
		return $?
	elif command -v nc >/dev/null 2>&1; then
		nc -z "$PGHOST" "$PGPORT" >/dev/null 2>&1
		return $?
	else
		# can't check, assume unreachable
		return 1
	fi
}

if [ "${SKIP_PRE_PUSH:-}" = "1" ]; then
	echo "Skipping pre-push checks (SKIP_PRE_PUSH=1)"
	exit 0
fi

echo "Running lightweight pre-push checks: frontend lint + type-check"
cd "$REPO_ROOT" || exit 1

# Frontend lint (biome) — fast and catches many CI regressions
if command -v make >/dev/null 2>&1; then
	if ! make lint-frontend; then
		echo "Frontend lint failed. Fix issues or set SKIP_PRE_PUSH=1 to bypass."
		exit 1
	fi
else
	echo "make not found; skipping frontend lint"
fi

# Type-check frontend
if [ -d frontend ]; then
	if command -v bun >/dev/null 2>&1; then
		(cd frontend && bun run type-check) || {
			echo "Type-check failed in frontend. Fix TypeScript errors or set SKIP_PRE_PUSH=1 to bypass."
			exit 1
		}
	elif command -v npx >/dev/null 2>&1; then
		(cd frontend && npx tsc --noEmit) || {
			echo "Type-check failed in frontend (npx tsc). Fix errors or set SKIP_PRE_PUSH=1 to bypass."
			exit 1
		}
	else
		echo "No TypeScript tool found (bun or npx); skipping type-check"
	fi
fi

# Optional: run full e2e smoke if explicitly requested
if [ "${FULL_E2E:-}" = "1" ]; then
	echo "FULL_E2E=1 set — running full e2e smoke runner (may be slow)"
	if ! check_pg; then
		echo "Postgres not reachable; attempting to start test DB via 'make test-e2e-up'"
		if command -v make >/dev/null 2>&1; then
			(cd "$REPO_ROOT" && make test-e2e-up) || echo "make test-e2e-up failed or requires privileges"
		fi
	fi
	"$REPO_ROOT/scripts/run-e2e-smoke.sh"
fi

echo "Pre-push lightweight checks passed."
